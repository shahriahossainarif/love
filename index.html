<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ultimate Cinematic Love Story üíñ</title>
  
  <!-- Core Libraries -->
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- New Libraries for Advanced Features -->
  <!-- Audio Engine -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <!-- Gesture/Swipe Engine -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
  <!-- PNG Download Engine -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Favicon & PWA Manifest -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíñ</text></svg>">
  <link rel="manifest" href="data:application/json,{%22name%22:%22Our Love Story%22,%22short_name%22:%22Love%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22theme_color%22:%22%23ff69b4%22,%22background_color%22:%22%231a1a2e%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíñ</text></svg>%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg+xml%22}]}">
  
  <style>
    :root {
      --primary-bg: #1a1a2e;
      --secondary-bg: #16213e;
      --accent-bg: #0f3460;
      --love-pink: #ff69b4;
      --gold: #ffd700;
      --sad-blue: #87ceeb;
      --base-font-size: 16px;
    }

    html {
      height: 100%;
    }

    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Georgia', 'Times New Roman', serif;
      background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 50%, var(--accent-bg) 100%);
      overflow: hidden;
      position: relative;
      cursor: none;
      perspective: 1000px; /* For 3D effects */
    }

    /* 1. VISUAL & ATMOSPHERIC EFFECTS */

    /* Parallax Background Image */
    body::before {
      content: '';
      position: absolute;
      top: -5%; left: -5%;
      width: 110%; height: 110%;
      /* Placeholder for the romantic couple image */
      background-image: url('https://placehold.co/1920x1080/1a1a2e/444444?text=Couple+Walking+in+Rain');
      background-size: cover;
      opacity: 0; /* Fades in during rain */
      background-blend-mode: overlay;
      filter: blur(5px);
      z-index: 1;
      transition: opacity 3s ease, filter 2s ease;
      transform: translateZ(-10px) scale(1.1);
    }
    body.rain-active::before {
      opacity: 0.8;
      filter: blur(8px);
    }

    /* Realistic Rain Canvas */
    #rainCanvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 2;
      pointer-events: none;
      opacity: 0;
      transition: opacity 2s ease-in-out;
    }
    #rainCanvas.active {
      opacity: 1;
    }

    /* EXTRA: Light blurry rain only at the top (new) */
    #topMistRain {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 38%;
      z-index: 3;
      pointer-events: none;
      opacity: 0.55;
      filter: blur(1.2px);
      mix-blend-mode: screen;
    }

    /* Lightning Effect */
    .lightning {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: white;
      opacity: 0;
      z-index: 2;
      pointer-events: none;
      animation: lightning-flash 5s infinite ease-out;
      animation-delay: 3s;
    }
    @keyframes lightning-flash {
      0%, 100% { opacity: 0; }
      2% { opacity: 0.8; }
      3% { opacity: 0.2; }
      4% { opacity: 1; }
      5% { opacity: 0; }
    }

    /* Godrays (Light Rays) Effect */
    .godray-container {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      z-index: 4;
      pointer-events: none;
      opacity: 0;
      transition: opacity 3s ease;
    }
    .godray-container.active {
      opacity: 0.7;
    }
    .godray {
      position: absolute;
      top: -50%;
      left: 50%;
      width: 4px;
      height: 200%;
      background: linear-gradient(to bottom, transparent 0%, rgba(255, 215, 0, 0.3) 50%, transparent 100%);
      transform-origin: top center;
      animation: godray-anim 10s ease-in-out infinite;
    }
    .godray:nth-child(2) { transform: rotate(10deg); animation-delay: -2s; }
    .godray:nth-child(3) { transform: rotate(-10deg); animation-delay: -4s; }
    .godray:nth-child(4) { transform: rotate(20deg); animation-delay: -6s; }
    .godray:nth-child(5) { transform: rotate(-20deg); animation-delay: -8s; }
    @keyframes godray-anim {
      0%, 100% { transform: scaleY(1) rotate(-20deg); opacity: 0.1; }
      50% { transform: scaleY(1.2) rotate(20deg); opacity: 0.5; }
    }

    /* Bokeh Lights */
    .bokeh-light {
      position: absolute;
      border-radius: 50%;
      background: var(--gold);
      opacity: 0.1;
      filter: blur(10px);
      animation: bokeh-float 20s infinite linear;
      z-index: 1;
    }
    @keyframes bokeh-float {
      0% { transform: translateY(100vh) scale(1); }
      100% { transform: translateY(-100vh) scale(1.5); }
    }

    /* Particle & Lighting Upgrades */
    .heart-particle {
      position: absolute;
      font-size: 20px;
      color: var(--love-pink);
      animation: float 8s infinite ease-in-out;
      opacity: 0.7;
      text-shadow: 0 0 10px var(--love-pink), 0 0 20px var(--love-pink); /* Light trail */
      transform-style: preserve-3d; /* For 3D */
    }
    .sparkle {
      box-shadow: 0 0 15px var(--gold), 0 0 25px var(--gold);
    }
    
    /* 3. EMOTIONAL INTERACTIVE FEATURES */

    /* Clickable Heart */
    .clickable-heart {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 100px;
      z-index: 5;
      cursor: pointer;
      opacity: 0;
      transition: all 1s ease;
      animation: pulse 2s infinite ease-in-out;
    }
    .clickable-heart.active {
      opacity: 1;
      color: var(--love-pink);
      text-shadow: 0 0 20px var(--love-pink);
    }
    @keyframes pulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.1); }
    }

    /* Rose Animation */
    .rose-bloom {
      position: absolute;
      bottom: 100px; left: 50%;
      transform: translateX(-50%) scale(0);
      font-size: 80px;
      opacity: 0;
      z-index: 5;
      transition: all 3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .rose-bloom.active {
      transform: translateX(-50%) scale(1) rotate(360deg);
      opacity: 1;
    }

    /* Butterfly (follows cursor) */
    .butterfly-cursor {
      position: fixed;
      font-size: 24px;
      z-index: 9999;
      pointer-events: none;
      transition: transform 0.1s ease-out;
      will-change: transform;
    }

    /* Hand-holding Animation */
    .hand-holding {
      position: absolute;
      bottom: 0; left: 50%;
      width: 400px; height: 200px;
      transform: translateX(-50%);
      z-index: 3;
      opacity: 0;
      transition: opacity 2s ease;
    }
    .hand-holding.active { opacity: 1; }
    .hand-left, .hand-right {
      position: absolute;
      bottom: 0;
      width: 50%;
      height: 100%;
      background-size: contain;
      background-repeat: no-repeat;
      transition: transform 3s ease-in-out;
    }
    .hand-left {
      left: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50 100 Q 40 80, 30 70 Q 20 60, 10 70 L 10 90 L 50 100' fill='%23fff' opacity='0.7' transform='scale(-1, 1) translate(-100, 0)' /%3E%3C/svg%3E");
      transform: translateX(-80%);
    }
    .hand-right {
      right: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50 100 Q 40 80, 30 70 Q 20 60, 10 70 L 10 90 L 50 100' fill='%23fff' opacity='0.7' /%3E%3C/svg%3E");
      transform: translateX(80%);
    }
    .hand-holding.active .hand-left { transform: translateX(0); }
    .hand-holding.active .hand-right { transform: translateX(0); }

    /* Custom Cursor */
    .custom-cursor {
      position: fixed;
      width: 20px;
      height: 20px;
      background: radial-gradient(circle, var(--love-pink), transparent);
      border-radius: 50%;
      pointer-events: none;
      z-index: 9999;
      transition: transform 0.1s ease;
      mix-blend-mode: screen;
    }
    .custom-cursor.clicked { transform: scale(2); }

    /* 5. CINEMATIC TRANSITIONS */
    .scene-transition-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: #000;
      opacity: 0;
      z-index: 100;
      pointer-events: none;
      transition: opacity 1.5s ease-in-out;
    }
    body.scene-transition-out .scene-transition-overlay {
      opacity: 1;
    }
    
    /* 6. TEXT & ANIMATION */
    .story-container {
      transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1), transform 0.1s ease-out;
      will-change: transform;
    }

    .message .cursor {
      display: inline-block;
      width: 3px;
      background: white;
      animation: blink 1s infinite;
      margin-left: 5px;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    /* Status pills (new) */
    .tone-statuses {
      display: flex; gap: 6px; flex-wrap: wrap;
      align-items: center; margin-left: 6px;
    }
    .tone-pill {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.25);
      color: #fff;
      backdrop-filter: blur(6px);
      white-space: nowrap;
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* 7. BONUS SURPRISES */

    .secret-input {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 200px;
      background: transparent;
      border: none;
      border-bottom: 1px dashed rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.5);
      text-align: center;
      z-index: 6;
      font-family: 'Georgia', serif;
      font-style: italic;
      outline: none;
    }
    .secret-input::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }

    #loveCounter {
      position: absolute;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      color: var(--gold);
      font-size: 1rem;
      text-shadow: 0 0 10px var(--gold);
      opacity: 0;
      transition: opacity 2s ease;
      z-index: 6;
    }
    #loveCounter.show {
      opacity: 1;
    }

    .language-controls {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 7;
      display: flex;
      gap: 5px;
    }
    .lang-btn {
      padding: 5px 10px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      color: white;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
    }
    .lang-btn:hover, .lang-btn.active {
      background: var(--love-pink);
    }
    
    /* --- Original Styles (retained) --- */
     .stars-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
     .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 3s infinite ease-in-out; }
     .star.small { width: 1px; height: 1px; }
     .star.medium { width: 2px; height: 2px; }
     .star.large { width: 3px; height: 3px; }
     .star.constellation { width: 4px; height: 4px; background: var(--gold); box-shadow: 0 0 10px var(--gold); }
     @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
     .shooting-star { position: absolute; width: 2px; height: 2px; background: linear-gradient(45deg, #fff, var(--gold)); border-radius: 50%; box-shadow: 0 0 15px var(--gold), 0 0 30px var(--gold); animation: shoot 4s linear infinite; opacity: 0; }
     @keyframes shoot { 0% { opacity: 1; transform: translateX(-100px) translateY(100px); } 100% { opacity: 0; transform: translateX(300px) translateY(-100px); } }
     .particles-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2; }
     @keyframes float { 0% { transform: translateY(100vh) rotate(0deg) scale(0.5); opacity: 0; } 10% { opacity: 0.7; transform: translateY(90vh) rotate(36deg) scale(1); } 90% { opacity: 0.7; transform: translateY(-10vh) rotate(324deg) scale(1); } 100% { transform: translateY(-100px) rotate(360deg) scale(0.5); opacity: 0; } }
     @keyframes sparkle { 0%, 100% { opacity: 0; transform: scale(0); } 50% { opacity: 1; transform: scale(1.5); } }
     .umbrella { position: absolute; font-size: calc(var(--base-font-size) * 4); z-index: 3; animation: umbrellaFloat 4s ease-in-out infinite; filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3)); }
     @keyframes umbrellaFloat { 0%, 100% { transform: translateY(0px) rotate(-2deg); } 50% { transform: translateY(-15px) rotate(2deg); } }
     .love-quote { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); padding: 20px 30px; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.2); color: var(--love-pink); font-style: italic; font-size: calc(var(--base-font-size) * 1.2); text-align: center; max-width: 500px; width: 90%; opacity: 0; z-index: 6; animation: quoteAppear 3s ease-in-out forwards; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); }
     @keyframes quoteAppear { 0% { opacity: 0; transform: translateX(-50%) translateY(-20px); } 20% { opacity: 1; transform: translateX(-50%) translateY(0px); } 80% { opacity: 1; } 100% { opacity: 0; transform: translateX(-50%) translateY(20px); } }
     .main-container { position: relative; z-index: 3; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; }
     .vignette { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, transparent 20%, rgba(0,0,0,0.6) 100%); pointer-events: none; z-index: 4; transition: opacity 2s ease; }
     .message { font-size: calc(var(--base-font-size) * 2.5); color: #ffffff; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8), 0 0 20px rgba(255, 255, 255, 0.3); margin-bottom: 30px; line-height: 1.4; letter-spacing: 1px; }
     .message.sad { color: var(--sad-blue); text-shadow: 2px 2px 8px rgba(135, 206, 235, 0.8), 0 0 30px rgba(135, 206, 235, 0.4); }
     .message.hopeful { color: var(--gold); text-shadow: 2px 2px 8px rgba(255, 215, 0, 0.8), 0 0 30px rgba(255, 215, 0, 0.4); }
     .message.love { color: var(--love-pink); text-shadow: 2px 2px 8px rgba(255, 105, 180, 0.8), 0 0 40px rgba(255, 105, 180, 0.6); font-size: calc(var(--base-font-size) * 3.2); animation: loveGlow 2s ease-in-out infinite alternate; }
     @keyframes loveGlow { 0% { text-shadow: 2px 2px 8px rgba(255, 105, 180, 0.8), 0 0 40px rgba(255, 105, 180, 0.6); } 100% { text-shadow: 2px 2px 12px rgba(255, 105, 180, 1), 0 0 60px rgba(255, 105, 180, 0.8); } }
     .memory-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: none; justify-content: center; align-items: center; z-index: 8; backdrop-filter: blur(15px); }
     .memory-container { background: rgba(255, 255, 255, 0.1); padding: 40px; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.2); text-align: center; backdrop-filter: blur(20px); max-width: 600px; width: 90%; }
     .memory-input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid rgba(255, 105, 180, 0.5); border-radius: 15px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 1.1rem; backdrop-filter: blur(10px); }
     .memory-input::placeholder { color: rgba(255, 255, 255, 0.7); }
     .progress-container { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 6; }
     .progress-dot { width: 14px; height: 14px; border-radius: 50%; background: rgba(255, 255, 255, 0.2); transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 80); }
     .progress-dot.active { background: var(--love-pink); box-shadow: 0 0 20px var(--love-pink), 0 0 40px rgba(255, 105, 180, 0.3); transform: scale(1.3); }
     .controls { position: absolute; top: 20px; right: 20px; z-index: 7; display: flex; gap: 10px; flex-wrap: wrap; }
     .control-btn { padding: 12px 18px; background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 30px; color: white; cursor: pointer; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 80); backdrop-filter: blur(15px); font-size: 14px; }
     .control-btn:hover { background: rgba(255, 255, 255, 0.25); transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); }
     .name-input-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: flex; justify-content: center; align-items: center; z-index: 10; backdrop-filter: blur(15px); }
     .name-input-container { background: rgba(255, 255, 255, 0.1); padding: 50px; border-radius: 25px; border: 1px solid rgba(255, 255, 255, 0.2); text-align: center; backdrop-filter: blur(25px); box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4); }
     .name-input-container h2 { color: var(--love-pink); margin-bottom: 25px; font-size: calc(var(--base-font-size) * 2.2); }
     .name-input { padding: 18px 25px; font-size: calc(var(--base-font-size) * 1.3); border: 2px solid rgba(255, 105, 180, 0.5); border-radius: 30px; background: rgba(255, 255, 255, 0.1); color: white; text-align: center; margin: 10px; width: 280px; backdrop-filter: blur(10px); transition: all 0.3s ease; }
     .name-input::placeholder { color: rgba(255, 255, 255, 0.7); }
     .name-input:focus { outline: none; border-color: var(--love-pink); box-shadow: 0 0 25px rgba(255, 105, 180, 0.4); transform: scale(1.05); }
     .start-btn, .replay-btn, .memory-btn { padding: 18px 35px; background: linear-gradient(45deg, var(--love-pink), #ff1493); border: none; border-radius: 30px; color: white; font-size: calc(var(--base-font-size) * 1.2); cursor: pointer; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 80); text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); margin: 10px; }
     .start-btn:hover, .replay-btn:hover, .memory-btn:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 15px 30px rgba(255, 105, 180, 0.5); }
     .broken-heart { position: absolute; font-size: calc(var(--base-font-size) * 5); color: #666; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; z-index: 2; filter: drop-shadow(0 0 10px rgba(102, 102, 102, 0.5)); }
     .broken-heart.healing { animation: heartHeal 4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
     @keyframes heartHeal { 0% { opacity: 1; color: #666; } 50% { color: #ff69b4; } 100% { opacity: 1; color: var(--love-pink); filter: drop-shadow(0 0 20px var(--love-pink)); } }
     .loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary-bg); display: flex; justify-content: center; align-items: center; z-index: 15; transition: opacity 1s ease; }
     .loading-heart { font-size: calc(var(--base-font-size) * 4); color: var(--love-pink); animation: loadingPulse 1.5s ease-in-out infinite; }
     @keyframes loadingPulse { 0%, 100% { transform: scale(1); opacity: 0.7; } 50% { transform: scale(1.3); opacity: 1; } }
     .replay-container { display:none !important; position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); z-index: 6; opacity: 0; transition: all 1s cubic-bezier(0.4, 0, 0.2, 80); display: flex; flex-direction: column; align-items: center; gap: 15px; }
     .replay-container.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
     @keyframes recordingPulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }

/* ===== Custom: Soft Rain Layer + Background Photos + Profile Lens ===== */
#softRainCanvas{ width:100%; height:100%;
  position:fixed; inset:0; z-index:2; pointer-events:none;
  opacity:0.4; filter:blur(0.6px);
}
#bgDecor{
  position:fixed; inset:0; z-index:2; pointer-events:none;
}
.bg-photos{ display:flex; align-items:center; justify-content:center;
  position:absolute; left:0; right:0; bottom:10px; height:240px; pointer-events:none;
}
.bg-photos img{
  position:absolute; bottom:0; width:220px; height:220px; object-fit:cover;
  opacity:0.18; filter:grayscale(10%) contrast(90%);
  box-shadow: 0 10px 40px rgba(0,0,0,0.35);
}
.bg-photos img.left { left:22px; border-radius:18px; }
.bg-photos img.center{ left:50%; transform:translateX(-50%); border-radius:18px; }
.bg-photos img.right{ right:22px; border-radius:18px; }

#bgProfileLens{
  position:absolute; left:28px; bottom:28px; width:120px; height:120px;
  border-radius:50%; overflow:hidden; pointer-events:none; z-index:2;
  border:4px solid rgba(255,255,255,0.45);
  box-shadow: 0 8px 30px rgba(0,0,0,0.35), inset 0 0 30px rgba(255,255,255,0.15);
  backdrop-filter: blur(1.5px);
}
#bgProfileLens img{
  width:100%; height:100%; object-fit:cover; transform:scale(1.05);
  filter:saturate(110%);
  opacity:0.9;
}
#bgProfileLens::after{
  content:'';
  position:absolute; width:60px; height:10px;
  left:95px; top:105px;
  border-radius:6px;
  background:linear-gradient(to right, rgba(255,255,255,0.5), rgba(255,255,255,0.1));
  transform:rotate(35deg);
  box-shadow: 0 6px 14px rgba(0,0,0,0.25);
}
.bg-photos.single{ bottom:0; top:0; height:auto; }
.bg-photos img.single-center{
  position:absolute; left:50%; top:50%;
  transform:translate(-50%,-50%);
  width:40vw; height:auto; max-width:700px; max-height:80vh;
  opacity:0.2; border-radius:20px; object-fit:cover;
}

</style>
</head>

<body>

  <!-- ===== Custom Background Layers ===== -->
  <div id="bgDecor" aria-hidden="true">
    <canvas id="softRainCanvas"></canvas>
    <div id="bgProfileLens"><img src="https://picsum.photos/id/1027/300/300" alt="Profile"/></div>
    
    <div class="bg-photos single">
      <img class="single-center" src="https://picsum.photos/id/1012/1200/800" alt="Family"/>
    </div>
  </div>

  <!-- NEW: Top-only misty rain canvas -->
  <canvas id="topMistRain"></canvas>

  <!-- 1. Visual & Atmospheric Effects -->
  <canvas id="rainCanvas"></canvas>
  <div class="lightning" id="lightning"></div>
  <div class="godray-container" id="godrayContainer">
    <div class="godray"></div> <div class="godray"></div> <div class="godray"></div>
    <div class="godray"></div> <div class="godray"></div>
  </div>
  <div class="stars-container" id="starsContainer"></div>
  <div class="particles-container" id="particlesContainer"></div>
  <div class="vignette" id="vignette"></div>

  <!-- 3. Emotional Interactive Features -->
  <div class="custom-cursor" id="customCursor"></div>
  <div class="butterfly-cursor" id="butterflyCursor">ü¶ã</div>
  <div class="clickable-heart" id="clickableHeart">üíñ</div>
  <div class="rose-bloom" id="roseBloom">üåπ</div>
  <div class="hand-holding" id="handHolding">
    <div class="hand-left"></div>
    <div class="hand-right"></div>
  </div>
  <div class="broken-heart" id="brokenHeart">üíî</div>
  
  <!-- 5. Cinematic Transitions -->
  <div class="scene-transition-overlay" id="sceneTransitionOverlay"></div>

  <!-- Loading Screen -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-heart">üíñ</div>
  </div>

  <!-- Main UI -->
  <div class="main-container">
    <div class="umbrella" id="umbrella" style="display: none;">‚òÇÔ∏è</div>
    <div class="love-quote" id="loveQuote"></div>
    <div class="story-container" id="storyContainer">
      <div class="message" id="messageText">
        Welcome to our story... üíñ
      </div>
    </div>
    <div class="progress-container" id="progressContainer">
      <div class="progress-dot active"></div> <div class="progress-dot"></div>
      <div class="progress-dot"></div> <div class="progress-dot"></div>
      <div class="progress-dot"></div> <div class="progress-dot"></div>
    </div>
    <div class="replay-container" id="replayContainer">
      <button class="replay-btn" onclick="restartStory()">üí´ Replay Our Story üí´</button>
      <!-- 4. Memories & Personalized Touch Buttons -->
      <button class="memory-btn" onclick="showMemoryCreator()">üì∏ Add Memory üì∏</button>
      <button class="memory-btn" onclick="showMemoryGallery()">üñºÔ∏è View Gallery</button>
      <button class="memory-btn" onclick="showLoveLetter()">üíå Write Letter</button>
      <button class="memory-btn" onclick="downloadAsLoveCard()">üíæ Download Card</button>
    </div>
  </div>

  <!-- 6. & 7. Language & Secret Input -->
  <div class="language-controls">
    <button class="lang-btn active" id="lang-en" onclick="changeLanguage('en')">EN</button>
    <button class="lang-btn" id="lang-bn" onclick="changeLanguage('bn')">BN</button>
    <button class="lang-btn" id="lang-hi" onclick="changeLanguage('hi')">HI</button>
  </div>

  <!-- Tone/Status Selector (Bengali) -->
  <div style="position:absolute; top:20px; right:20px; z-index:7; display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
    <label style="color:#fff; font-size:12px;">‡¶Æ‡ßÅ‡¶°:</label>
    <select id="toneSelect" style="padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.1); color:#fff; border:1px solid rgba(255,255,255,0.2);"></select>
    <!-- NEW: two status pills will render here -->
    <div id="toneStatuses" class="tone-statuses" aria-live="polite"></div>
  </div>

  <input type="text" class="secret-input" id="secretInput" placeholder="A secret word...">
  <div id="loveCounter"></div>

  <!-- Top Controls -->
  <div class="controls">
    <button class="control-btn" onclick="toggleAudio()" id="audioBtn">üîä Audio</button>
    <button class="control-btn" onclick="skipToNext()" id="skipBtn">‚è≠Ô∏è Skip</button>
    <button class="control-btn" onclick="toggleFullscreen()" id="fullscreenBtn">üî≥ Full</button>
  </div>

  <!-- 8. AI & Voice Controls -->
  <div class="ai-controls">
    <button class="ai-btn" onclick="generateAIQuote()" id="aiQuoteBtn">‚ú® AI Quote</button>
    <button class="ai-btn" onclick="generateAIVoice()" id="aiVoiceBtn">üó£Ô∏è AI Voice</button>
  </div>
  
  <!-- Overlays -->
  <div class="name-input-overlay" id="nameInputOverlay">
    <div class="name-input-container">
      <h2>üíñ Before we begin... üíñ</h2>
      <p style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">What are your beautiful names?</p>
      <input type="text" class="name-input" id="herNameInput" placeholder="Her name..." maxlength="20">
      <input type="text" class="name-input" id="yourNameInput" placeholder="Your name..." maxlength="20">
      <p style="color: rgba(255,255,255,0.8); margin: 20px 0 10px;">When did your story begin? (for Love Counter)</p>
      <input type="date" class="name-input" id="loveStartDateInput">
      <br><button class="start-btn" onclick="startStory()">Begin Our Story ‚ú®</button>
    </div>
  </div>

  <div class="memory-overlay" id="memoryOverlay">
    <div class="memory-container">
      <h2 style="color: var(--love-pink); margin-bottom: 20px;">üì∏ Create a Memory</h2>
      <input type="text" class="memory-input" id="memoryText" placeholder="Describe this beautiful memory...">
      <input type="date" class="memory-input" id="memoryDate">
      <input type="text" class="memory-input" id="memoryImage" placeholder="Image URL (optional)...">
      <select class="memory-input" id="memoryType">
        <option value="first_meeting">First Meeting</option>
        <option value="first_date">First Date</option>
        <option value="special_moment">Special Moment</option>
        <option value="anniversary">Anniversary</option>
        <option value="adventure">Adventure Together</option>
        <option value="quiet_moment">Quiet Moment</option>
      </select>
      <div style="margin-top: 20px;">
        <button class="memory-btn" onclick="saveMemory()">üíæ Save Memory</button>
        <button class="memory-btn" onclick="hideMemoryCreator()">‚ùå Cancel</button>
      </div>
    </div>
  </div>

  <div class="memory-gallery-overlay" id="memoryGalleryOverlay">
    <div id="memoryGalleryContent"></div>
    <div class="gallery-nav">
      <button class="nav-btn" onclick="changeMemorySlide(-1)">‚ùÆ</button>
      <button class="nav-btn" onclick="changeMemorySlide(1)">‚ùØ</button>
    </div>
    <button class="nav-btn close-gallery-btn" onclick="hideMemoryGallery()">‚úñ</button>
  </div>
  
  <div class="love-letter-overlay" id="loveLetterOverlay">
    <div class="love-letter-container">
      <h2>üíå Your Love Letter</h2>
      <textarea id="loveLetterTextarea" placeholder="Write your personal message here..."></textarea>
      <div style="margin-top: 20px;">
        <button class="memory-btn" onclick="saveLoveLetter()">üíæ Save</button>
        <button class="memory-btn" onclick="hideLoveLetter()">‚ùå Close</button>
      </div>
    </div>
  </div>


  <script>
    // --- Global State & Config ---
    const defaultConfig = {
      love_interest_name: "Beautiful",
      your_name: "Love",
      story_title: "Our Love Story",
      opening_message: "I need to tell you something...",
      apology_message: "I'm sorry for hurting you",
      love_declaration: "You mean everything to me",
      future_message: "Let's make new memories",
      final_message: "I Love You Forever",
      enable_memories: "yes",
      background_color: "#1a1a2e",
      accent_color: "#ff69b4",
      font_family: "Georgia",
      font_size: 16
    };

    let currentConfig = { ...defaultConfig };

    // --- Bengali Tone/Status Presets ---
    const tonePresets = [
      {key:'‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶æ', opening_message:'‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡ßÉ‡¶¶‡¶Ø‡¶º ‡¶ï‡ßá‡¶¨‡¶≤ ‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá‡¶á ‡¶°‡¶æ‡¶ï‡ßá...', apology_message:'‡¶ï‡¶ñ‡¶®‡ßã ‡¶Ø‡¶¶‡¶ø ‡¶ï‡¶∑‡ßç‡¶ü ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶•‡¶æ‡¶ï‡¶ø, ‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ ‡¶ï‡ßã‡¶∞‡ßã', love_declaration:'‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∂‡ßç‡¶¨‡¶æ‡¶∏‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã', future_message:'‡¶ö‡¶≤‡ßã ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶∞‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶ø', final_message:'‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá ‡¶ö‡¶ø‡¶∞‡¶¶‡¶ø‡¶® ‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶¨'},
      {key:'‡¶¶‡ßÅ‡¶É‡¶ñ ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂', opening_message:'‡¶Ü‡¶ú ‡¶Æ‡¶®‡¶ü‡¶æ ‡¶≠‡¶æ‡¶∞‡ßÄ...', apology_message:'‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶ï‡¶∑‡ßç‡¶ü ‡¶™‡ßá‡¶Ø‡¶º‡ßá‡¶õ', love_declaration:'‡¶§‡¶¨‡ßÅ ‡¶π‡ßÉ‡¶¶‡¶Ø‡¶º‡¶ü‡¶æ ‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá‡¶á ‡¶ö‡¶æ‡¶Ø‡¶º', future_message:'‡¶Ü‡¶∞ ‡¶ï‡¶∑‡ßç‡¶ü ‡¶¶‡ßá‡¶¨ ‡¶®‡¶æ', final_message:'‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶∂‡¶æ‡¶®‡ßç‡¶§‡¶ø'},
      {key:'‡¶∏‡¶∞‡¶ø', opening_message:'‡¶è‡¶ï‡¶ü‡¶æ ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶á‚ÄîSorry', apology_message:'‡¶Ü‡¶Æ‡¶ø ‡¶∏‡¶§‡ßç‡¶Ø‡¶ø‡¶á ‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§', love_declaration:'‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶Ö‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø', future_message:'‡¶∏‡¶¨ ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶¨', final_message:'Please, ‡¶Ü‡¶∞‡ßá‡¶ï‡¶ü‡¶æ ‡¶∏‡ßÅ‡¶Ø‡ßã‡¶ó ‡¶¶‡¶æ‡¶ì'},
      {key:'‡¶Æ‡¶ø‡¶∏ ‡¶á‡¶â', opening_message:'‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá ‡¶ñ‡ßÅ‡¶¨ ‡¶Æ‡¶®‡ßá ‡¶™‡¶°‡¶º‡¶õ‡ßá', apology_message:'‡¶¶‡ßÇ‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡¶≤‡ßá‡¶ì ‡¶Æ‡¶®‡¶ü‡¶æ ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá‡¶á', love_declaration:'‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶õ‡¶æ‡¶°‡¶º‡¶æ ‡¶¶‡¶ø‡¶® ‡¶ï‡¶æ‡¶ü‡ßá ‡¶®‡¶æ', future_message:'‡¶¶‡ßá‡¶ñ‡¶æ ‡¶π‡¶≤‡ßá ‡¶∂‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßá ‡¶ú‡¶°‡¶º‡¶æ‡¶¨‡ßã', final_message:'‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶°‡¶º‡¶ø'},
      {key:'‡¶∞‡¶æ‡¶ó‡ßá‡¶∞ ‡¶™‡¶∞ ‡¶∂‡¶æ‡¶®‡ßç‡¶§‡¶ø', opening_message:'‡¶∞‡¶æ‡¶ó ‡¶ï‡ßá‡¶ü‡ßá ‡¶ó‡ßá‡¶õ‡ßá', apology_message:'‡¶Ø‡¶æ ‡¶¨‡¶≤‡ßá‡¶õ‡¶ø‚Äî‡¶≠‡ßÅ‡¶≤ ‡¶õ‡¶ø‡¶≤', love_declaration:'‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ', future_message:'‡¶ö‡¶≤‡ßã ‡¶∂‡¶æ‡¶®‡ßç‡¶§‡¶ø‡¶§‡ßá ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶ø', final_message:'‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶•‡¶æ‡¶ï‡¶¨'},
      {key:'‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ', opening_message:'‡¶Ü‡¶ú ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ', apology_message:'‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶≠‡ßÅ‡¶≤‡¶ó‡ßÅ‡¶≤‡ßã ‡¶™‡ßá‡¶õ‡¶®‡ßá ‡¶´‡ßá‡¶≤‡¶ø', love_declaration:'‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶π‡¶æ‡¶§‡¶ü‡¶æ ‡¶ß‡¶∞‡ßã', future_message:'‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡ßç‡¶¨‡¶™‡ßç‡¶® ‡¶ó‡¶°‡¶º‡¶ø', final_message:'‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶™‡¶æ‡¶∞‡¶¨'},
      {key:'‡¶ï‡ßÉ‡¶§‡¶ú‡ßç‡¶û‡¶§‡¶æ', opening_message:'‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶™‡¶æ‡¶∂‡ßá ‡¶•‡¶æ‡¶ï‡¶æ‡¶Ø‡¶º ‡¶ß‡¶®‡ßç‡¶Ø', apology_message:'‡¶Ü‡¶Æ‡¶ø ‡¶ï‡¶ñ‡¶®‡ßã ‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá ‡¶Ö‡¶¨‡¶π‡ßá‡¶≤‡¶æ ‡¶ï‡¶∞‡¶¨ ‡¶®‡¶æ', love_declaration:'‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶∂‡ßÄ‡¶∞‡ßç‡¶¨‡¶æ‡¶¶', future_message:'‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶¶‡¶ø‡¶® ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø', final_message:'Thank you, my love'},
      {key:'‡¶®‡¶∞‡¶Æ ‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶æ', opening_message:'‡¶ö‡ßÅ‡¶™‡¶ö‡¶æ‡¶™ ‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶ø', apology_message:'‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶æ‡¶∏‡¶ø ‡¶Ø‡ßá‡¶® ‡¶®‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶Ø‡¶º', love_declaration:'‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶§‡¶Æ‡¶æ', future_message:'‡¶è‡¶ï‡¶ü‡¶æ ‡¶ï‡¶´‡¶ø ‡¶°‡ßá‡¶ü ‡¶π‡¶¨‡ßá?', final_message:'‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶ø'},
      {key:'‡¶ó‡¶≠‡ßÄ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶≠‡ßÇ‡¶§‡¶ø', opening_message:'‡¶∂‡¶¨‡ßç‡¶¶‡ßá ‡¶¨‡ßã‡¶ù‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶®‡¶æ', apology_message:'‡¶π‡ßÉ‡¶¶‡¶Ø‡¶º‡¶ü‡¶æ ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá‡¶á', love_declaration:'‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶Ü‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶ø ‡¶®‡¶á', future_message:'‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶æ‡¶§ ‡¶õ‡¶æ‡¶°‡¶º‡¶¨ ‡¶®‡¶æ', final_message:'‡¶ö‡¶ø‡¶∞‡¶¶‡¶ø‡¶® ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞'},
      {key:'‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∂‡ßç‡¶∞‡ßÅ‡¶§‡¶ø', opening_message:'‡¶Ü‡¶Æ‡¶ø ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∂‡ßç‡¶∞‡ßÅ‡¶§‡¶ø ‡¶¶‡¶ø‡¶ö‡ßç‡¶õ‡¶ø', apology_message:'‡¶Ø‡¶æ ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨', love_declaration:'‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶∏‡ßÅ‡¶ñ‡¶á ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ', future_message:'‡¶∏‡¶¨‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶†‡¶ø‡¶ï‡¶†‡¶æ‡¶ï ‡¶ï‡¶∞‡¶¨', final_message:'‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá‚Äî‡¶∏‡¶¨‡¶∏‡¶Æ‡¶Ø‡¶º'},
      {key:'‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶£‡¶æ', opening_message:'‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶ï‡ßá ‡¶∂‡¶ï‡ßç‡¶§‡¶ø ‡¶¶‡¶æ‡¶ì', apology_message:'‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶≠‡ßÅ‡¶≤‡ßá ‡¶•‡ßá‡¶Æ‡ßá ‡¶Ø‡ßá‡¶ì ‡¶®‡¶æ', love_declaration:'‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶£‡¶æ', future_message:'‡¶∏‡ßç‡¶¨‡¶™‡ßç‡¶® ‡¶ú‡¶Ø‡¶º‡ßá‡¶∞ ‡¶™‡¶•‡ßá ‡¶ö‡¶≤‡¶ø', final_message:'‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶â‡¶°‡¶º‡¶¨'},
      {key:'‡¶Æ‡¶® ‡¶ú‡ßÅ‡¶°‡¶º‡¶æ‡¶®‡ßã', opening_message:'‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶∏‡ßç‡¶Æ‡¶ø‡¶§‡¶π‡¶æ‡¶∏‡¶ø ‡¶Æ‡¶® ‡¶≠‡¶∞‡ßá ‡¶¶‡ßá‡¶Ø‡¶º', apology_message:'‡¶¶‡ßÇ‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡¶≤‡ßá‡¶ì ‡¶Ö‡¶®‡ßÅ‡¶≠‡¶¨‡ßá ‡¶ï‡¶æ‡¶õ‡ßá', love_declaration:'‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡¶æ‡¶®‡ßç‡¶§‡¶ø', future_message:'‡¶è‡¶ï ‡¶ï‡¶æ‡¶™ ‡¶ö‡¶æ, ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶∏‡¶Æ‡¶Ø‡¶º', final_message:'‡¶ö‡¶≤‡ßã, ‡¶®‡¶∞‡¶Æ ‡¶∏‡ßÅ‡¶ñ‡ßá ‡¶¨‡¶æ‡¶Å‡¶ö‡¶ø'},
      {key:'‡¶∞‡¶æ‡¶§‡ßá‡¶∞ ‡¶®‡ßÄ‡¶∞‡¶¨‡¶§‡¶æ', opening_message:'‡¶ö‡¶æ‡¶Å‡¶¶‡ßá‡¶∞ ‡¶Ü‡¶≤‡ßã‡¶Ø‡¶º ‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá‡¶á ‡¶≠‡¶æ‡¶¨‡¶ø', apology_message:'‡¶®‡ßÄ‡¶∞‡¶¨‡¶§‡¶æ ‡¶Ø‡¶¶‡¶ø ‡¶ï‡¶∑‡ßç‡¶ü ‡¶¶‡ßá‡¶Ø‡¶º, ‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ ‡¶ï‡ßã‡¶∞‡ßã', love_declaration:"‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶õ‡¶æ‡¶°‡¶º‡¶æ ‡¶§‡¶æ‡¶∞‡¶æ ‡¶´‡¶ø‡¶ï‡ßá", future_message:'‡¶≠‡ßã‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶π‡¶¨‡ßá', final_message:'‡¶∂‡ßÅ‡¶≠‡¶∞‡¶æ‡¶§‡ßç‡¶∞‡¶ø, ‡¶™‡ßç‡¶∞‡¶ø‡¶Ø‡¶º'},
      {key:'‡¶∏‡¶æ‡¶®‡ßç‡¶§‡ßç‡¶¨‡¶®‡¶æ', opening_message:'‡¶Æ‡¶®‡¶ü‡¶æ ‡¶Ø‡¶¶‡¶ø ‡¶¨‡ßç‡¶Ø‡¶•‡¶æ‡¶Ø‡¶º ‡¶≠‡¶∞‡ßá', apology_message:'‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶™‡¶æ‡¶∂‡ßá ‡¶Ü‡¶õ‡¶ø', love_declaration:'‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶ö‡ßã‡¶ñ‡ßá‡¶á ‡¶ò‡¶∞ ‡¶™‡¶æ‡¶á', future_message:'‡¶∏‡¶¨ ‡¶†‡¶ø‡¶ï ‡¶π‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá', final_message:'‡¶Ü‡¶Æ‡¶ø ‡¶Ü‡¶õ‡¶ø, ‡¶•‡¶æ‡¶ï‡¶¨'},
      {key:'‡¶Ü‡¶∂‡¶æ', opening_message:'‡¶Ü‡¶∂‡¶æ‡¶∞ ‡¶Ü‡¶≤‡ßã ‡¶ú‡ßç‡¶¨‡¶≤‡ßá', apology_message:'‡¶ï‡¶æ‡¶≤‡¶ï‡ßá ‡¶≠‡¶æ‡¶≤‡ßã ‡¶π‡¶¨‡ßá', love_declaration:'‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶∏‡¶ï‡¶æ‡¶≤', future_message:'‡¶π‡¶æ‡¶∏‡¶ø‡¶∞ ‡¶¶‡¶ø‡¶® ‡¶Ü‡¶∏‡¶¨‡ßá‡¶á', final_message:'‡¶π‡¶æ‡¶≤ ‡¶õ‡ßá‡¶°‡¶º‡ßã ‡¶®‡¶æ'},
      {key:'‡¶ß‡ßà‡¶∞‡ßç‡¶Ø', opening_message:'‡¶ß‡ßÄ‡¶∞‡ßá ‡¶ß‡ßÄ‡¶∞‡ßá ‡¶∏‡¶¨‡¶á ‡¶π‡¶Ø‡¶º', apology_message:'‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶∂‡¶ø‡¶ñ‡¶õ‡¶ø ‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá', love_declaration:'‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßÄ', future_message:'‡¶π‡¶æ‡¶§‡¶ü‡¶æ ‡¶∂‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßá ‡¶ß‡¶∞‡ßã', final_message:'‡¶∂‡ßá‡¶∑‡ßá ‡¶π‡¶æ‡¶∏‡¶¨‡ßã ‡¶Ü‡¶Æ‡¶∞‡¶æ'},
      {key:'‡¶â‡¶ö‡ßç‡¶õ‡ßç‡¶¨‡¶æ‡¶∏', opening_message:'‡¶Ü‡¶ú ‡¶Æ‡¶®‡¶ü‡¶æ ‡¶®‡¶æ‡¶ö‡ßá', apology_message:'‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶â‡¶¶‡¶Ø‡¶æ‡¶™‡¶® ‡¶ö‡¶æ‡¶á', love_declaration:'‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶®‡¶®‡ßç‡¶¶', future_message:'‡¶ö‡¶≤‡ßã ‡¶ï‡ßã‡¶•‡¶æ‡¶ì ‡¶¨‡ßá‡¶°‡¶º‡¶æ‡¶á', final_message:'‡¶≤‡¶æ‡¶≠ ‡¶á‡¶â!'},
      {key:'‡¶∂‡¶æ‡¶®‡ßç‡¶§ ‡¶¶‡ßÅ‡¶™‡ßÅ‡¶∞', opening_message:'‡¶∞‡ßã‡¶¶‡¶ù‡¶≤‡¶Æ‡¶≤‡ßá ‡¶®‡¶ø‡¶∏‡ßç‡¶§‡¶¨‡ßç‡¶ß‡¶§‡¶æ', apology_message:'‡¶è‡¶ï‡¶ü‡ßÅ ‡¶¨‡¶ø‡¶∂‡ßç‡¶∞‡¶æ‡¶Æ ‡¶®‡¶æ‡¶ì', love_declaration:'‡¶§‡ßã‡¶Æ‡¶æ‡¶§‡ßá‡¶á ‡¶∂‡¶æ‡¶®‡ßç‡¶§‡¶ø', future_message:'‡¶¨‡¶ø‡¶ï‡ßá‡¶≤‡ßá ‡¶π‡¶æ‡¶Å‡¶ü‡¶§‡ßá ‡¶Ø‡¶æ‡¶á', final_message:'‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∏‡¶¨ ‡¶∂‡¶æ‡¶®‡ßç‡¶§'},
      {key:'‡¶¨‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø ‡¶≠‡ßá‡¶ú‡¶æ', opening_message:'‡¶ú‡¶æ‡¶®‡¶æ‡¶≤‡¶æ‡¶Ø‡¶º ‡¶ü‡ßÅ‡¶™‡¶ü‡¶æ‡¶™', apology_message:'‡¶ö‡¶≤‡ßá ‡¶è‡¶∏‡ßã‚Äî‡¶ö‡ßÅ‡¶™‡¶ö‡¶æ‡¶™ ‡¶¨‡¶∏‡¶ø', love_declaration:'‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶∞ ‡¶Ü‡¶Æ‡¶ø, ‡¶è‡¶ï ‡¶ï‡¶æ‡¶™ ‡¶ö‡¶æ', future_message:'‡¶≠‡ßá‡¶ú‡¶æ ‡¶∞‡¶æ‡¶∏‡ßç‡¶§‡¶æ‡¶Ø‡¶º ‡¶π‡¶æ‡¶Å‡¶ü‡¶ø', final_message:'‡¶è‡¶á ‡¶Æ‡ßÅ‡¶π‡ßÇ‡¶∞‡ßç‡¶§‡¶ü‡¶æ‡¶á ‡¶∏‡¶¨'},
      {key:'‡¶ï‡¶¨‡¶ø‡¶§‡¶æ‡¶∞ ‡¶õ‡¶®‡ßç‡¶¶', opening_message:'‡¶è‡¶ï‡¶ü‡¶ø ‡¶ï‡¶¨‡¶ø‡¶§‡¶æ ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßá', apology_message:'‡¶∂‡¶¨‡ßç‡¶¶‡ßá ‡¶Ø‡¶¶‡¶ø ‡¶ï‡¶∑‡ßç‡¶ü ‡¶≤‡¶æ‡¶ó‡ßá', love_declaration:'‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶õ‡¶®‡ßç‡¶¶, ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ö‡¶∞‡ßç‡¶•', future_message:'‡¶ï‡¶æ‡¶ó‡¶ú‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶ó‡¶≤‡ßç‡¶™', final_message:'‡¶∂‡ßá‡¶∑ ‡¶≤‡¶æ‡¶á‡¶®‚Äî‡¶§‡ßÅ‡¶Æ‡¶ø'}
    ];

    function applyToneByKey(key){
      const t = tonePresets.find(x=>x.key===key);
      if(!t) return;
      currentConfig.opening_message = t.opening_message;
      currentConfig.apology_message = t.apology_message;
      currentConfig.love_declaration = t.love_declaration;
      currentConfig.future_message = t.future_message;
      currentConfig.final_message = t.final_message;
      renderToneStatuses(key); // NEW: update two visible statuses
    }

    let currentScene = 0;
    let isPlaying = false;
    let audioEnabled = true;
    let storyInterval;
    let herName = "";
    let yourName = "";
    let loveStartDate = new Date();
    let memories = [];
    let currentMemoryIndex = 0;
    let currentLang = 'bn';
    let audioContextStarted = false;

    // API Key placeholder
    const apiKey = ""; 

    // --- 6. Multi-language Support ---
    const translations = {
      en: {
        welcome: "Welcome to our story... üíñ",
        herNamePlaceholder: "Her name...",
        yourNamePlaceholder: "Your name...",
        storyBegin: "Begin Our Story ‚ú®",
        scene1: () => currentConfig.opening_message || "I need to tell you something...",
        scene2: () => `${currentConfig.apology_message || "I'm sorry for hurting you"}, ${herName} üíî`,
        scene3: () => `I remember when we first met... üí≠`,
        scene4: () => `${currentConfig.love_declaration || "You mean everything to me"}, ${herName} üíñ`,
        scene5: () => `${currentConfig.future_message || "Let's make new memories"}, ${herName} üåü`,
        scene6: () => `${currentConfig.final_message || "I Love You Forever"}, ${herName} üíû`,
        replay: "üí´ Replay Our Story üí´",
        addMemory: "üì∏ Add Memory üì∏",
        viewGallery: "üñºÔ∏è View Gallery",
        writeLetter: "üíå Write Letter",
        downloadCard: "üíæ Download Card",
        secretPlaceholder: "A secret word...",
        aiQuoteBtn: "‚ú® AI Quote",
        aiVoiceBtn: "üó£Ô∏è AI Voice",
        aiVoiceText: () => `I love you, ${herName}`
      },
      bn: {
        welcome: "‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ó‡¶≤‡ßç‡¶™‡ßá ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ... üíñ",
        herNamePlaceholder: "‡¶§‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ...",
        yourNamePlaceholder: "‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ...",
        storyBegin: "‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ó‡¶≤‡ßç‡¶™ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶® ‚ú®",
        scene1: () => "‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶¨‡¶≤‡¶æ‡¶∞ ‡¶Ü‡¶õ‡ßá...",
        scene2: () => `‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá ‡¶Ü‡¶ò‡¶æ‡¶§ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ${herName} üíî`,
        scene3: () => `‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡¶®‡ßá ‡¶Ü‡¶õ‡ßá ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶¶‡ßá‡¶ñ‡¶æ... üí≠`,
        scene4: () => `‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶∏‡¶¨‡¶ï‡¶ø‡¶õ‡ßÅ, ${herName} üíñ`,
        scene5: () => `‡¶ö‡¶≤‡ßã ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶Æ‡ßÉ‡¶§‡¶ø ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶ø, ${herName} üåü`,
        scene6: () => `‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá ‡¶ö‡¶ø‡¶∞‡¶ï‡¶æ‡¶≤ ‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶ø, ${herName} üíû`,
        replay: "üí´ ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ó‡¶≤‡ßç‡¶™ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® üí´",
        addMemory: "üì∏ ‡¶∏‡ßç‡¶Æ‡ßÉ‡¶§‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® üì∏",
        viewGallery: "üñºÔ∏è ‡¶ó‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡¶ø ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®",
        writeLetter: "üíå ‡¶ö‡¶ø‡¶†‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®",
        downloadCard: "üíæ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®",
        secretPlaceholder: "‡¶è‡¶ï‡¶ü‡¶ø ‡¶ó‡ßã‡¶™‡¶® ‡¶∂‡¶¨‡ßç‡¶¶...",
        aiQuoteBtn: "‚ú® ‡¶è‡¶Ü‡¶á ‡¶â‡¶ï‡ßç‡¶§‡¶ø",
        aiVoiceBtn: "üó£Ô∏è ‡¶è‡¶Ü‡¶á ‡¶≠‡¶Ø‡¶º‡ßá‡¶∏",
        aiVoiceText: () => `‡¶Ü‡¶Æ‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá ‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶ø, ${herName}`
      },
      hi: {
        welcome: "‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§ï‡§π‡§æ‡§®‡•Ä ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à... üíñ",
        herNamePlaceholder: "‡§â‡§∏‡§ï‡§æ ‡§®‡§æ‡§Æ...",
        yourNamePlaceholder: "‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§∞‡§æ ‡§®‡§æ‡§Æ...",
        storyBegin: "‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§ï‡§π‡§æ‡§®‡•Ä ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç ‚ú®",
        scene1: () => "‡§Æ‡•Å‡§ù‡•á ‡§§‡•Å‡§Æ‡§∏‡•á ‡§ï‡•Å‡§õ ‡§ï‡§π‡§®‡§æ ‡§π‡•à...",
        scene2: () => `‡§§‡•Å‡§Æ‡•ç‡§π‡•á‡§Ç ‡§†‡•á‡§∏ ‡§™‡§π‡•Å‡§Å‡§ö‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡•Å‡§ù‡•á ‡§ñ‡•á‡§¶ ‡§π‡•à, ${herName} üíî`,
        scene3: () => `‡§Æ‡•Å‡§ù‡•á ‡§Ø‡§æ‡§¶ ‡§π‡•à ‡§ú‡§¨ ‡§π‡§Æ ‡§™‡§π‡§≤‡•Ä ‡§¨‡§æ‡§∞ ‡§Æ‡§ø‡§≤‡•á ‡§•‡•á... üí≠`,
        scene4: () => `‡§§‡•Å‡§Æ ‡§Æ‡•á‡§∞‡•á ‡§≤‡§ø‡§è ‡§∏‡§¨ ‡§ï‡•Å‡§õ ‡§π‡•ã, ${herName} üíñ`,
        scene5: () => `‡§ö‡§≤‡•ã ‡§®‡§à ‡§Ø‡§æ‡§¶‡•á‡§Ç ‡§¨‡§®‡§æ‡§§‡•á ‡§π‡•à‡§Ç, ${herName} üåü`,
        scene6: () => `‡§Æ‡•à‡§Ç ‡§§‡•Å‡§Æ‡§∏‡•á ‡§π‡§Æ‡•á‡§∂‡§æ ‡§™‡•ç‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡•Ç‡§Å‡§ó‡§æ, ${herName} üíû`,
        replay: "üí´ ‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§ï‡§π‡§æ‡§®‡•Ä ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§¶‡•á‡§ñ‡•á‡§Ç üí´",
        addMemory: "üì∏ ‡§Æ‡•á‡§Æ‡•ã‡§∞‡•Ä ‡§ú‡•ã‡§°‡§º‡•á‡§Ç üì∏",
        viewGallery: "üñºÔ∏è ‡§ó‡•à‡§≤‡§∞‡•Ä ‡§¶‡•á‡§ñ‡•á‡§Ç",
        writeLetter: "üíå ‡§™‡§§‡•ç‡§∞ ‡§≤‡§ø‡§ñ‡•á‡§Ç",
        downloadCard: "üíæ ‡§ï‡§æ‡§∞‡•ç‡§° ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç",
        secretPlaceholder: "‡§è‡§ï ‡§ó‡•Å‡§™‡•ç‡§§ ‡§∂‡§¨‡•ç‡§¶...",
        aiQuoteBtn: "‚ú® ‡§è‡§Ü‡§à ‡§â‡§¶‡•ç‡§ß‡§∞‡§£",
        aiVoiceBtn: "üó£Ô∏è ‡§è‡§Ü‡§à ‡§Ü‡§µ‡§æ‡§ú",
        aiVoiceText: () => `‡§Æ‡•à‡§Ç ‡§§‡•Å‡§Æ‡§∏‡•á ‡§™‡•ç‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§§‡§æ ‡§π‡•Ç‡§Å, ${herName}`
      }
    };
    
    // --- 7. Bonus: Love Quotes (Original) ---
    const loveQuotes = [
       "In your eyes, I found my home. In your heart, I found my love. In your soul, I found my mate.",
       "You are my today and all of my tomorrows.",
       "I love you not only for what you are, but for what I am when I am with you.",
       "Every love story is beautiful, but ours is my favorite.",
       "‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶π‡¶æ‡¶∏‡¶ø‡¶§‡ßá ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßÉ‡¶•‡¶ø‡¶¨‡ßÄ ‡¶Ü‡¶≤‡ßã‡¶ï‡¶ø‡¶§ ‡¶π‡ßü‡•§",
       "‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ú‡ßÄ‡¶¨‡¶®‡ßá‡¶∞ ‡¶∏‡¶¨‡¶ö‡ßá‡ßü‡ßá ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞ ‡¶Ö‡¶ß‡ßç‡¶Ø‡¶æ‡ßü‡•§",
       "‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡¶æ‡¶ü‡¶æ‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶π‡ßÇ‡¶∞‡ßç‡¶§ ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶Ö‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡•§",
       "‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶π‡ßÉ‡¶¶‡ßü‡ßá‡¶∞ ‡¶∏‡ßç‡¶™‡¶®‡ßç‡¶¶‡¶®, ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶¨‡ßá‡¶Å‡¶ö‡ßá ‡¶•‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£‡•§",
       "‡¶ö‡ßã‡¶ñ ‡¶ñ‡ßÅ‡¶≤‡¶≤‡ßá‡¶á ‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá ‡¶¶‡ßá‡¶ñ‡¶ø, ‡¶ö‡ßã‡¶ñ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶≤‡ßá‡¶ì ‡¶§‡ßÅ‡¶Æ‡¶ø‡•§",
       "‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶∏‡ßá‡¶á ‡¶∏‡ßç‡¶¨‡¶™‡ßç‡¶® ‡¶Ø‡¶æ ‡¶Ü‡¶Æ‡¶ø ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶® ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶ö‡¶æ‡¶á‡•§",
       "‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶∏‡¶¨ ‡¶ñ‡ßÅ‡¶∂‡¶ø ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá‡•§"
    ];

    // --- Data SDK (Original) ---
    let dataHandler = {
      onDataChanged(data) {
        memories = data || [];
        console.log('Memories updated:', memories.length);
      }
    };

    // --- Scenes (unchanged) ---
    const scenes = [
      {
        getMessage: () => translations[currentLang].scene1(),
        className: "sad",
        duration: 6000,
        effects: ["startRain", "dimLights", "playSadPiano", "showSadCoupleBG", "vibrateShort"]
      },
      {
        getMessage: () => translations[currentLang].scene2(),
        className: "sad",
        duration: 7000,
        effects: ["heavyRain", "brokenHeart", "lightningFlash", "zoomIn", "vibrateLong"]
      },
      {
        getMessage: () => translations[currentLang].scene3(),
        className: "hopeful",
        duration: 6000,
        effects: ["showMemoryGallery", "crossfadeToHopefulStrings", "stopRain"]
      },
      {
        getMessage: () => translations[currentLang].scene4(),
        className: "hopeful",
        duration: 7000,
        effects: ["heartHeal", "sparkles", "lightReturn", "roseBloom", "godRays", "vibrateHeartbeat"]
      },
      {
        getMessage: () => translations[currentLang].scene5(),
        className: "hopeful",
        duration: 6000,
        effects: ["butterfliesFollow", "brightMusic", "nameInStars"]
      },
      {
        getMessage: () => translations[currentLang].scene6(),
        className: "love",
        duration: 10000,
        effects: ["celebration", "fireworks", "heartRain", "crossfadeToRomanticGuitar", "playSwell", "handHolding"]
      }
    ];

    // --- 2) Emotional Background Sound (NEW) ---
    // Uses a soft, royalty-free ambient piano. Attempts autoplay on visit; falls back to first user interaction.
    const emotionalAudio = new Audio("https://cdn.pixabay.com/download/audio/2021/10/26/audio_7a5d6b0f0d.mp3?filename=emotional-piano-19190.mp3");
    emotionalAudio.loop = true;
    emotionalAudio.volume = 0.18;
    emotionalAudio.preload = "auto";

    async function tryPlayEmotionalAudio(){
      try{
        await emotionalAudio.play();
        console.log("Emotional bg sound playing.");
      }catch(e){
        console.warn("Autoplay blocked; will resume on first interaction.", e);
        const resume = async ()=>{
          try { await emotionalAudio.play(); } catch(_) {}
          window.removeEventListener('pointerdown', resume);
          window.removeEventListener('touchstart', resume);
        };
        window.addEventListener('pointerdown', resume, { once:true });
        window.addEventListener('touchstart', resume, { once:true });
      }
    }

    // --- 3) Top Misty Rain (NEW) ---
    const topMist = {
      canvas:null, ctx:null, w:0, h:0, drops:[],
      init(){
        this.canvas = document.getElementById('topMistRain');
        if(!this.canvas) return;
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        window.addEventListener('resize', ()=>this.resize());
        // make light drops
        this.drops = Array.from({length:120}).map(()=>this.makeDrop());
        this.frame();
      },
      resize(){
        this.w = this.canvas.width = window.innerWidth;
        this.h = this.canvas.height = Math.floor(window.innerHeight*0.38);
      },
      makeDrop(){
        return {
          x: Math.random()*this.w,
          y: -Math.random()*this.h,
          len: 6 + Math.random()*16,
          spd: 1.2 + Math.random()*2.2,
          alpha: 0.07 + Math.random()*0.12,
          drift: -0.5 + Math.random()*1.0,
          thick: 0.6 + Math.random()*0.8
        };
      },
      frame(){
        const c=this.ctx; if(!c) return;
        c.clearRect(0,0,this.w,this.h);
        c.save();
        c.globalCompositeOperation = 'lighter';
        c.strokeStyle = 'rgba(255,255,255,0.85)';
        c.filter = 'blur(0.8px)';
        c.lineCap='round';
        for(const d of this.drops){
          c.globalAlpha = d.alpha;
          c.lineWidth = d.thick;
          c.beginPath();
          c.moveTo(d.x, d.y);
          c.lineTo(d.x + d.drift, d.y + d.len);
          c.stroke();
          d.y += d.spd*2.5;
          d.x += d.drift*0.6;
          if(d.y > this.h+20){ // recycle
            const nd = this.makeDrop();
            d.x = nd.x; d.y = -10; d.len = nd.len; d.spd = nd.spd; d.alpha=nd.alpha; d.drift=nd.drift; d.thick=nd.thick;
          }
        }
        c.restore();
        requestAnimationFrame(()=>this.frame());
      }
    };

    // --- 2. Music & SFX with Tone.js (retained) ---
    const audioManager = {
      synths: {}, sfx: {}, musicVolume: new Tone.Volume(-12).toDestination(), sfxVolume: new Tone.Volume(0).toDestination(),
      isInitialized: false,
      init: async function() {
        if (this.isInitialized) return;
        await Tone.start();
        this.synths.sadPiano = new Tone.PolySynth(Tone.FMSynth, {
          envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 1 },
          harmonicity: 3, modulationIndex: 2
        }).connect(this.musicVolume);
        this.synths.hopefulStrings = new Tone.PolySynth(Tone.AMSynth, {
          envelope: { attack: 1.5, decay: 0, sustain: 1, release: 2 },
          harmonicity: 1.5
        }).connect(this.musicVolume);
        this.synths.romanticGuitar = new Tone.PluckSynth({ attackNoise: 0.5, dampening: 4000, resonance: 0.7 }).connect(this.musicVolume);
        this.sfx.heartbeat = new Tone.MembraneSynth({ pitchDecay: 0.05, octaves: 10, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 } }).connect(this.sfxVolume);
        this.sfx.chime = new Tone.MetalSynth({ frequency: 300, envelope: { attack: 0.001, decay: 1, release: 1 }, harmonicity: 5.1, modulationIndex: 32, resonance: 4000 }).connect(this.sfxVolume);
        this.sfx.swell = new Tone.NoiseSynth({ noise: { type: 'pink' }, envelope: { attack: 4, decay: 0.1, sustain: 0.3, release: 4 } }).connect(this.musicVolume);
        this.sfx.rain = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.1, decay: 0.5, sustain: 1, release: 1 } }).connect(new Tone.Filter(1000, "lowpass").connect(this.sfxVolume));
        this.sfx.rain.volume.value = -20;
        this.isInitialized = true;
        console.log("Audio Engine Initialized (Tone.js)");
      },
      loops: {
        sadPiano: new Tone.Sequence((time, note) => { audioManager.synths.sadPiano.triggerAttackRelease(note, "1n", time); }, ["C3", ["E3", "G3"], "G3", ["C4", "E4"]], "1m"),
        hopefulStrings: new Tone.Sequence((time, note) => { audioManager.synths.hopefulStrings.triggerAttackRelease(note, "2m", time); }, [["C4", "E4", "G4"], ["G4", "B4", "D5"], ["F4", "A4", "C5"]], "2m"),
        romanticGuitar: new Tone.Sequence((time, note) => { audioManager.synths.romanticGuitar.triggerAttackRelease(note, "8n", time); }, ["C4", "E4", "G4", "E4", "F4", "A4", "G4", "C5"], "2n")
      },
      crossfade: function(trackInName, trackOutName) {
        if (!this.isInitialized || !audioEnabled) return;
        if (trackOutName && this.loops[trackOutName].state === "started") {
          this.synths[trackOutName].volume.rampTo(-Infinity, 2.0);
          this.loops[trackOutName].stop("+2.0");
        }
        if (trackInName && this.loops[trackInName].state !== "started") {
          this.synths[trackInName].volume.value = -Infinity;
          this.loops[trackInName].start(0);
          this.synths[trackInName].volume.rampTo(0, 3.0);
        }
        Tone.Transport.start();
      },
      playSfx: function(effect) {
        if (!this.isInitialized || !audioEnabled) return;
        const now = Tone.now();
        switch(effect) {
          case 'heartbeat':
            this.sfx.heartbeat.triggerAttackRelease("C2", "8n", now);
            this.sfx.heartbeat.triggerAttackRelease("C2", "8n", now + 0.5);
            break;
          case 'chime': this.sfx.chime.triggerAttackRelease(now); break;
          case 'swell': this.sfx.swell.triggerAttackRelease("4m", now); break;
          case 'startRain': this.sfx.rain.triggerAttack(); break;
          case 'stopRain': this.sfx.rain.triggerRelease("+1.0"); break;
        }
      },
      toggle: function() {
        audioEnabled = !audioEnabled;
        const btn = document.getElementById('audioBtn');
        if (!audioEnabled) {
          Tone.Transport.pause();
          this.musicVolume.value = -Infinity;
          btn.textContent = 'üîá Muted';
          try{ emotionalAudio.pause(); }catch(_){}
        } else {
          if (!this.isInitialized) this.init();
          Tone.Transport.start();
          this.musicVolume.value = -12;
          btn.textContent = 'üîä Audio';
          tryPlayEmotionalAudio();
        }
        return audioEnabled;
      }
    };

    // --- 1. Realistic Rain (Canvas) --- (retained)
    const rainAnimator = {
      canvas: null, ctx: null, raindrops: [], splashes: [], W: 0, H: 0, running: false,
      init: function() {
        this.canvas = document.getElementById('rainCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.W = window.innerWidth; this.H = window.innerHeight;
        this.canvas.width = this.W; this.canvas.height = this.H;
        for(let i = 0; i < 200; i++) { this.raindrops.push(this.createDrop()); }
      },
      createDrop: function() { return { x: Math.random() * this.W, y: Math.random() * -this.H, l: Math.random() * 2 + 2, vy: Math.random() * 5 + 10, opacity: Math.random() * 0.3 + 0.2 }; },
      createSplash: function(x, y) {
        for(let i = 0; i < 5; i++) {
          this.splashes.push({ x: x, y: y, vx: Math.random() * 4 - 2, vy: Math.random() * -2 - 1, life: 1.0, radius: Math.random() * 1 + 1 });
        }
      },
      drawPuddles: function() {
        this.ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
        this.ctx.beginPath();
        this.ctx.ellipse(this.W / 2, this.H - 20, this.W * 0.4, 30, 0, 0, 2 * Math.PI);
        this.ctx.fill();
        this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
        this.ctx.lineWidth = 1;
        for(let i = 0; i < 3; i++) {
          this.ctx.beginPath();
          this.ctx.ellipse(this.W / 2, this.H - 20, Math.random() * this.W * 0.3, Math.random() * 20, 0, 0, 2 * Math.PI);
          this.ctx.stroke();
        }
      },
      draw: function() {
        if (!this.running) return;
        this.ctx.clearRect(0, 0, this.W, this.H);
        this.drawPuddles();
        this.ctx.lineWidth = 1.5;
        for(let i = 0; i < this.raindrops.length; i++) {
          const d = this.raindrops[i];
          this.ctx.strokeStyle = `rgba(174,194,224, ${d.opacity})`;
          this.ctx.beginPath();
          this.ctx.moveTo(d.x, d.y);
          this.ctx.lineTo(d.x, d.y + d.l);
          this.ctx.stroke();
          d.y += d.vy;
          if (d.y > this.H - 40 + Math.random() * 20) {
            this.createSplash(d.x, d.y);
            this.raindrops[i] = this.createDrop();
          }
        }
        this.ctx.fillStyle = 'rgba(174,194,224, 0.5)';
        for(let i = this.splashes.length - 1; i >= 0; i--) {
          const s = this.splashes[i];
          this.ctx.beginPath();
          this.ctx.arc(s.x, s.y, s.radius, 0, Math.PI * 2);
          this.ctx.fill();
          s.x += s.vx; s.y += s.vy; s.vy += 0.1; s.life -= 0.05;
          if (s.life <= 0) { this.splashes.splice(i, 80); }
        }
        requestAnimationFrame(this.draw.bind(this));
      },
      start: function() {
        if (this.running) return;
        this.running = true;
        this.canvas.classList.add('active');
        document.body.classList.add('rain-active');
        audioManager.playSfx('startRain');
        this.draw();
      },
      stop: function() {
        this.running = false;
        this.canvas.classList.remove('active');
        document.body.classList.remove('rain-active');
        audioManager.playSfx('stopRain');
      }
    };

    // --- App Initialization ---
    async function init() {
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) console.error('Failed to initialize Data SDK');
      }

      createStars();
      createParticles();
      setupCustomCursor();
      initParallax();
      init3DTextTilt();
      initSwipeGestures();
      rainAnimator.init();

      // NEW: start top mist rain & emotional sound
      topMist.init();
      tryPlayEmotionalAudio();

      const savedHerName = localStorage.getItem('loveStoryHerName');
      const savedYourName = localStorage.getItem('loveStoryYourName');
      const savedLoveDate = localStorage.getItem('loveStoryLoveDate');
      if (savedHerName) document.getElementById('herNameInput').value = savedHerName;
      if (savedYourName) document.getElementById('yourNameInput').value = savedYourName;
      if (savedLoveDate) document.getElementById('loveStartDateInput').value = savedLoveDate;

      loadLoveLetter();
      document.getElementById('secretInput').addEventListener('input', handleSecretInput);
      changeLanguage(currentLang);

      try {
        const herEl = document.getElementById('herNameInput');
        const yourEl = document.getElementById('yourNameInput');
        const dateEl = document.getElementById('loveStartDateInput');
        if (herEl) herEl.value = 'Runa Akter';
        if (yourEl) yourEl.value = 'Abdus Subhan';
        if (dateEl) dateEl.value = '2011-11-11';
        changeLanguage('bn');
        if (typeof startStory === 'function') startStory();
        const overlay = document.getElementById('nameInputOverlay');
        if (overlay) overlay.style.display = 'none';
      } catch(e) { console.warn('Auto-start setup failed:', e); }

      setTimeout(() => {
        document.getElementById('loadingOverlay').style.opacity = '0';
        setTimeout(() => {
          document.getElementById('loadingOverlay').style.display = 'none';
        }, 1000);
      }, 2000);
    }
    
    function initSwipeGestures() {
      const hammer = new Hammer(document.body);
      hammer.on('swipeleft', skipToNext);
      hammer.on('swiperight', () => {
        if (isPlaying && currentScene > 0) {
          clearTimeout(storyInterval);
          currentScene--;
          playScene(currentScene);
        }
      });
    }

    function initParallax() {
      const bg = document.querySelector('body::before');
      document.body.addEventListener('mousemove', (e) => {
        if (!bg) return;
        const x = (e.clientX - window.innerWidth / 2) / (window.innerWidth / 2);
        const y = (e.clientY - window.innerHeight / 2) / (window.innerHeight / 2);
        bg.style.transform = `translateX(${-x * 20}px) translateY(${-y * 20}px) translateZ(-10px) scale(1.1)`;
      });
      window.addEventListener('deviceorientation', (event) => {
        const tiltY = event.gamma; const tiltX = event.beta;
        if (tiltX && tiltY) { bg.style.transform = `translateX(${tiltY * 0.5}px) translateY(${tiltX * 0.5}px) translateZ(-10px) scale(1.1)`; }
      });
    }

    function init3DTextTilt() {
      const container = document.getElementById('storyContainer');
      container.addEventListener('mousemove', (e) => {
        const rect = container.getBoundingClientRect();
        const x = e.clientX - rect.left - rect.width / 2;
        const y = e.clientY - rect.top - rect.height / 2;
        const rotateY = x / (rect.width / 2) * 5;
        const rotateX = -y / (rect.height / 2) * 5;
        container.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
      });
      container.addEventListener('mouseleave', () => {
        container.style.transform = 'rotateX(0) rotateY(0)';
      });
    }

    function typewriterEffect(element, text, callback) {
      let i = 0;
      element.innerHTML = '';
      const cursorSpan = document.createElement('span');
      cursorSpan.className = 'cursor';
      cursorSpan.innerHTML = '&nbsp;';
      function type() {
        if (i < text.length) {
          element.innerHTML = text.substring(0, i + 1);
          element.appendChild(cursorSpan);
          i++;
          if (audioManager.isInitialized && currentScene > 3) {
             audioManager.synths.romanticGuitar.triggerAttackRelease(text[i] === " " ? "C4" : "E4", "16n", Tone.now());
          }
          setTimeout(type, 70);
        } else {
          cursorSpan.style.animation = 'none';
          cursorSpan.style.opacity = 0;
          if (callback) callback();
        }
      }
      type();
    }

    function changeLanguage(lang) {
      currentLang = lang;
      document.documentElement.lang = lang;
      document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`lang-${lang}`).classList.add('active');
      document.getElementById('herNameInput').placeholder = translations[lang].herNamePlaceholder;
      document.getElementById('yourNameInput').placeholder = translations[lang].yourNamePlaceholder;
      document.querySelector('.start-btn').textContent = translations[lang].storyBegin;
      document.querySelector('.replay-btn').textContent = translations[lang].replay;
      document.querySelector('.memory-btn[onclick="showMemoryCreator()"]').textContent = translations[lang].addMemory;
      document.querySelector('.memory-btn[onclick="showMemoryGallery()"]').textContent = translations[lang].viewGallery;
      document.querySelector('.memory-btn[onclick="showLoveLetter()"]').textContent = translations[lang].writeLetter;
      document.querySelector('.memory-btn[onclick="downloadAsLoveCard()"]').textContent = translations[lang].downloadCard;
      document.getElementById('secretInput').placeholder = translations[lang].secretPlaceholder;
      document.getElementById('aiQuoteBtn').textContent = translations[lang].aiQuoteBtn;
      document.getElementById('aiVoiceBtn').textContent = translations[lang].aiVoiceBtn;
      if (!isPlaying) {
        document.getElementById('messageText').textContent = translations[lang].welcome;
      }
    }

    // NEW: Render two status pills based on current tone
    function renderToneStatuses(key){
      const t = tonePresets.find(x=>x.key===key);
      const wrap = document.getElementById('toneStatuses');
      if(!wrap) return;
      wrap.innerHTML = '';
      if(!t) return;
      // pick two short statuses from opening & final message
      const s1 = (t.opening_message||'').slice(0, 22);
      const s2 = (t.final_message||'').slice(0, 22);
      const pill1 = document.createElement('div'); pill1.className='tone-pill'; pill1.textContent = s1;
      const pill2 = document.createElement('div'); pill2.className='tone-pill'; pill2.textContent = s2;
      wrap.appendChild(pill1); wrap.appendChild(pill2);
    }

    function initLoveCounter() {
      try {
        const diffTime = Math.abs(new Date() - loveStartDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        const counterEl = document.getElementById('loveCounter');
        counterEl.textContent = `You've been my love for ${diffDays} days.`;
        counterEl.classList.add('show');
      } catch (e) {
        console.warn("Invalid love start date");
      }
    }

    function handleSecretInput(e) {
      if (e.target.value.toLowerCase().includes('i forgive you')) {
        showRoseAnimation(true);
        e.target.value = 'üíñ';
      }
    }

    function showRoseAnimation(isSpecial = false) {
      const rose = document.getElementById('roseBloom');
      rose.classList.add('active');
      audioManager.playSfx('chime');
      if (isSpecial) { rose.style.filter = 'drop-shadow(0 0 20px var(--gold))'; }
      setTimeout(() => { rose.classList.remove('active'); rose.style.filter = 'none'; }, 4000);
    }

    async function generateAIQuote() {
      const btn = document.getElementById('aiQuoteBtn');
      btn.classList.add('loading'); btn.disabled = true;
      const systemPrompt = "You are a world-class romantic poet. Generate a single, short, beautiful romantic quote. The quote must be unique and touching. Do not use quotation marks. Be concise.";
      const userQuery = `Please generate a quote that includes the name "${herName}".`;
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
      try {
        const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) { throw new Error(`API Error: ${response.statusText}`); }
        const result = await response.json();
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
        if (text) { showCustomQuote(text); } else { showCustomQuote("My love for you is beyond words."); }
      } catch (error) {
        console.error('Error generating AI quote:', error);
        showCustomQuote(`Every moment with you, ${herName}, is a treasure.`);
      } finally {
        btn.classList.remove('loading'); btn.disabled = false;
      }
    }

    async function generateAIVoice() {
      if (!audioEnabled) toggleAudio();
      const btn = document.getElementById('aiVoiceBtn');
      btn.classList.add('loading'); btn.disabled = true;
      const textToSpeak = translations[currentLang].aiVoiceText();
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
      try {
        const payload = {
          contents: [{ parts: [{ text: `Say with a warm, loving, and slightly breathy tone: ${textToSpeak}` }] }],
          generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } },
          model: "gemini-2.5-flash-preview-tts"
        };
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
        const result = await response.json();
        const part = result?.candidates?.[0]?.content?.parts?.[0];
        const audioData = part?.inlineData?.data;
        const mimeType = part?.inlineData?.mimeType;
        if (audioData && mimeType && mimeType.startsWith("audio/")) {
            const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
            const pcmData = base64ToArrayBuffer(audioData);
            const pcm16 = new Int16Array(pcmData);
            const wavBlob = pcmToWav(pcm16, sampleRate);
            const audioUrl = URL.createObjectURL(wavBlob);
            const audio = new Audio(audioUrl);
            audio.play();
        } else {
            throw new Error("Invalid audio data received.");
        }
      } catch (error) {
        console.error('Error generating AI voice:', error);
      } finally {
        btn.classList.remove('loading'); btn.disabled = false;
      }
    }

    function base64ToArrayBuffer(base64) {
        const binaryString = window.atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
        return bytes.buffer;
    }
    function pcmToWav(pcmData, sampleRate) {
        const numChannels = 1;
        const bitsPerSample = 16;
        const dataSize = pcmData.length * (bitsPerSample / 8);
        const blockAlign = numChannels * (bitsPerSample / 8);
        const byteRate = sampleRate * blockAlign;
        const buffer = new ArrayBuffer(44 + dataSize);
        const view = new DataView(buffer);
        writeString(view, 0, 'RIFF');
        view.setUint32(4, 36 + dataSize, true);
        writeString(view, 8, 'WAVE');
        writeString(view, 12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, numChannels, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, byteRate, true);
        view.setUint16(32, blockAlign, true);
        view.setUint16(34, bitsPerSample, true);
        writeString(view, 36, 'data');
        view.setUint32(40, dataSize, true);
        let offset = 44;
        for (let i = 0; i < pcmData.length; i++, offset += 2) { view.setInt16(offset, pcmData[i], true); }
        return new Blob([view], { type: 'audio/wav' });
    }
    function writeString(view, offset, string) { for (let i = 0; i < string.length; i++) { view.setUint8(offset + i, string.charCodeAt(i)); } }

    async function startStory() {
      herName = document.getElementById('herNameInput').value.trim() || "Beautiful";
      yourName = document.getElementById('yourNameInput').value.trim() || "Love";
      try {
        loveStartDate = new Date(document.getElementById('loveStartDateInput').value);
        if (isNaN(loveStartDate.getTime())) throw new Error();
        localStorage.setItem('loveStoryLoveDate', document.getElementById('loveStartDateInput').value);
      } catch(e) { loveStartDate = new Date(); }
      localStorage.setItem('loveStoryHerName', herName);
      localStorage.setItem('loveStoryYourName', yourName);
      document.getElementById('nameInputOverlay').style.display = 'none';
      startLoveQuotes();
      initLoveCounter();
      isPlaying = true;
      currentScene = 0;
      playScene(0);
      if (!audioManager.isInitialized) {
        audioManager.init().catch(err => {
            console.warn("Audio failed to initialize:", err);
            document.getElementById('audioBtn').textContent = 'üîá Muted';
            audioEnabled = false;
        });
      }
    }

    function startLoveQuotes() {
      const quoteElement = document.getElementById('loveQuote');
      let quoteIndex = 0;
      function showNextQuote() {
        if (isPlaying && quoteIndex < loveQuotes.length) {
          showCustomQuote(loveQuotes[quoteIndex]);
          quoteIndex++;
          setTimeout(showNextQuote, 6000);
        } else if (isPlaying) {
          quoteIndex = 0;
          setTimeout(showNextQuote, 2000);
        }
      }
      setTimeout(showNextQuote, 3000);
    }
    
    function showCustomQuote(quote) {
        const quoteElement = document.getElementById('loveQuote');
        const personalizedQuote = quote.replace(/you/gi, herName);
        quoteElement.textContent = `"${personalizedQuote}"`;
        quoteElement.style.animation = 'none';
        void quoteElement.offsetWidth;
        quoteElement.style.animation = 'quoteAppear 4s ease-in-out forwards';
    }

    function playScene(sceneIndex) {
      if (sceneIndex >= scenes.length) { endStory(); return; }
      if (!isPlaying) return;
      currentScene = sceneIndex;
      const scene = scenes[sceneIndex];
      const messageElement = document.getElementById('messageText');
      document.body.classList.add('scene-transition-out');
      setTimeout(() => {
        if (!isPlaying) return;
        messageElement.className = `message ${scene.className}`;
        updateProgressDots(sceneIndex);
        applySceneEffects(scene.effects);
        typewriterEffect(messageElement, scene.getMessage(), () => {
          document.body.classList.remove('scene-transition-out');
        });
        storyInterval = setTimeout(() => { if (isPlaying) { playScene(currentScene + 1); } }, scene.duration);
      }, 80);
    }

    function applySceneEffects(effects) {
      document.getElementById('lightning').style.display = 'none';
      document.getElementById('godrayContainer').classList.remove('active');
      document.getElementById('clickableHeart').classList.remove('active');
      document.getElementById('handHolding').classList.remove('active');
      stopButterflyCursor();
      effects.forEach(effect => {
        switch(effect) {
          case 'playSadPiano': audioManager.crossfade('sadPiano'); break;
          case 'crossfadeToHopefulStrings': audioManager.crossfade('hopefulStrings', 'sadPiano'); break;
          case 'crossfadeToRomanticGuitar': audioManager.crossfade('romanticGuitar', 'hopefulStrings'); break;
          case 'playSwell': audioManager.playSfx('swell'); break;
          case 'startRain':
          case 'heavyRain':
            rainAnimator.start(); document.getElementById('umbrella').style.display = 'block'; break;
          case 'stopRain':
            rainAnimator.stop(); document.getElementById('umbrella').style.display = 'none'; break;
          case 'dimLights': document.getElementById('vignette').style.opacity = '0.8'; break;
          case 'lightReturn': document.getElementById('vignette').style.opacity = '0.4'; break;
          case 'showSadCoupleBG': document.body.classList.add('rain-active'); break;
          case 'lightningFlash': document.getElementById('lightning').style.display = 'block'; break;
          case 'godRays': document.getElementById('godrayContainer').classList.add('active'); break;
          case 'zoomIn': document.getElementById('storyContainer').style.transform = 'scale(1.05)'; break;
          case 'brokenHeart':
            const brokenHeart = document.getElementById('brokenHeart');
            brokenHeart.style.opacity = '1'; setTimeout(() => { brokenHeart.style.opacity = '0'; }, 3000);
            break;
          case 'heartHeal':
            const healingHeart = document.getElementById('brokenHeart');
            healingHeart.classList.add('healing'); healingHeart.style.opacity = '1';
            setTimeout(() => { healingHeart.style.opacity = '0'; healingHeart.classList.remove('healing'); document.getElementById('clickableHeart').classList.add('active'); }, 4000);
            break;
          case 'roseBloom': showRoseAnimation(); break;
          case 'butterfliesFollow': startButterflyCursor(); break;
          case 'handHolding': document.getElementById('handHolding').classList.add('active'); break;
          case 'showMemoryGallery': showMemoryGallery(); break;
          case 'nameInStars': createConstellation(); break;
          case 'celebration':
          case 'fireworks':
          case 'heartRain':
            createCelebrationEffect(); break;
          case 'vibrateShort': if(navigator.vibrate) navigator.vibrate(200); break;
          case 'vibrateLong': if(navigator.vibrate) navigator.vibrate(500); break;
          case 'vibrateHeartbeat': if(navigator.vibrate) navigator.vibrate([100, 50, 100, 300]); break;
        }
      });
    }

    function endStory() {
      isPlaying = false;
      rainAnimator.stop();
      document.getElementById('vignette').style.opacity = '0.2';
      document.getElementById('replayContainer').classList.add('show');
      document.getElementById('clickableHeart').classList.remove('active');
      document.getElementById('handHolding').classList.remove('active');
      stopButterflyCursor();
    }

    function restartStory() {
      document.getElementById('replayContainer').classList.remove('show');
      currentScene = 0; isPlaying = true; playScene(0);
    }
    
    function skipToNext() {
      if (isPlaying && currentScene < scenes.length) {
        clearTimeout(storyInterval); playScene(currentScene + 1);
      }
    }

    function downloadAsLoveCard() {
      const node = document.getElementById('storyContainer');
      const btn = document.querySelector('.memory-btn[onclick="downloadAsLoveCard()"]');
      btn.textContent = "Downloading...";
      html2canvas(node, { backgroundColor: 'var(--primary-bg)', allowTaint: true, useCORS: true, scale: 2 }).then(canvas => {
        const link = document.createElement('a');
        link.download = `love-story-for-${herName}.png`; link.href = canvas.toDataURL('image/png'); link.click();
        btn.textContent = translations[currentLang].downloadCard;
      }).catch(err => { console.error("Error downloading card:", err); btn.textContent = "Error! Try again."; });
    }

    function showLoveLetter() { document.getElementById('loveLetterOverlay').style.display = 'flex'; }
    function hideLoveLetter() { document.getElementById('loveLetterOverlay').style.display = 'none'; }
    function saveLoveLetter() { const text = document.getElementById('loveLetterTextarea').value; localStorage.setItem('loveStoryLetter', text); hideLoveLetter(); }
    function loadLoveLetter() { const text = localStorage.getItem('loveStoryLetter'); if (text) { document.getElementById('loveLetterTextarea').value = text; } }

    function showMemoryGallery() {
      if (memories.length === 0) { showCustomQuote("Add some memories first!"); return; }
      currentMemoryIndex = 0; buildMemorySlides(); document.getElementById('memoryGalleryOverlay').style.display = 'flex';
    }
    function hideMemoryGallery() { document.getElementById('memoryGalleryOverlay').style.display = 'none'; }
    function buildMemorySlides() {
      const container = document.getElementById('memoryGalleryContent');
      container.innerHTML = '';
      memories.forEach((mem, index) => {
        const slide = document.createElement('div');
        slide.className = `memory-slide ${index === 0 ? 'active' : ''}`; slide.dataset.index = index;
        const tone = (mem.memory_type === 'first_meeting' || mem.memory_type === 'quiet_moment') ? 'cool' : 'warm';
        slide.classList.add(tone);
        const imgUrl = mem.memory_image || `https://placehold.co/600x400/333/fff?text=${mem.memory_text.split(' ')[0]}`;
        slide.innerHTML = `<img src="${imgUrl}" alt="${mem.memory_text}"><p>"${mem.memory_text}"</p><p style="font-size: 1rem; color: #ccc;">(${new Date(mem.memory_date).toLocaleDateString()})</p>`;
        container.appendChild(slide);
      });
    }
    function changeMemorySlide(direction) {
      currentMemoryIndex += direction;
      if (currentMemoryIndex < 0) currentMemoryIndex = memories.length - 1;
      if (currentMemoryIndex >= memories.length) currentMemoryIndex = 0;
      document.querySelectorAll('.memory-slide').forEach(slide => {
        slide.classList.toggle('active', parseInt(slide.dataset.index) === currentMemoryIndex);
      });
    }

    async function saveMemory() {
      const text = document.getElementById('memoryText').value.trim();
      const date = document.getElementById('memoryDate').value;
      const type = document.getElementById('memoryType').value;
      const image = document.getElementById('memoryImage').value.trim();
      if (!text || !date) { showCustomQuote("Please fill in both memory text and date!"); return; }
      const memory = { memory_id: Date.now().toString(), memory_text: text, memory_date: date, memory_type: type, memory_image: image, created_at: new Date().toISOString() };
      if (window.dataSdk) {
        const result = await window.dataSdk.create(memory);
        if (result.isOk) { hideMemoryCreator(); showCustomQuote("üíæ Memory saved! ‚ú®"); }
        else { showCustomQuote("Failed to save memory. Please try again."); }
      }
    }
    
    function showMemoryCreator() {
      document.getElementById('memoryOverlay').style.display = 'flex';
      document.getElementById('memoryText').value = '';
      document.getElementById('memoryImage').value = '';
      document.getElementById('memoryDate').value = new Date().toISOString().split('T')[0];
    }
    function hideMemoryCreator() { document.getElementById('memoryOverlay').style.display = 'none'; }
    function updateProgressDots(activeIndex) {
      const dots = document.querySelectorAll('.progress-dot');
      dots.forEach((dot, index) => { dot.classList.toggle('active', index === activeIndex); });
    }
    function toggleAudio() { return audioManager.toggle(); }
    function toggleFullscreen() {
      if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); document.getElementById('fullscreenBtn').textContent = 'üî≤ Exit'; }
      else { document.exitFullscreen(); document.getElementById('fullscreenBtn').textContent = 'üî≥ Full'; }
    }
    function createStars() {
      const container = document.getElementById('starsContainer');
      for (let i = 0; i < 150; i++) {
        const star = document.createElement('div');
        const types = ['small', 'medium', 'large'];
        star.className = `star ${types[Math.floor(Math.random() * types.length)]}`;
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDelay = Math.random() * 3 + 's';
        container.appendChild(star);
      }
      setInterval(() => {
        if (Math.random() < 0.4) {
          const sStar = document.createElement('div');
          sStar.className = 'shooting-star';
          sStar.style.top = Math.random() * 50 + '%';
          sStar.style.left = '0%';
          sStar.style.animationDuration = (3 + Math.random() * 2) + 's';
          container.appendChild(sStar);
          setTimeout(() => { if (container.contains(sStar)) container.removeChild(sStar); }, 6000);
        }
      }, 6000);
    }
    function createParticles() {
      const container = document.getElementById('particlesContainer');
      setInterval(() => {
        if (isPlaying) {
          const heart = document.createElement('div');
          heart.className = 'heart-particle';
          heart.innerHTML = ['üíñ', 'üíï', 'üíó', 'üíù', 'üíû', 'üíò'][Math.floor(Math.random() * 6)];
          heart.style.left = Math.random() * 100 + '%';
          heart.style.fontSize = (15 + Math.random() * 15) + 'px';
          heart.style.animationDuration = (6 + Math.random() * 4) + 's';
          container.appendChild(heart);
          setTimeout(() => { if (container.contains(heart)) container.removeChild(heart); }, 12000);
        }
      }, 1200);
      for (let i = 0; i < 15; i++) {
        const bokeh = document.createElement('div');
        bokeh.className = 'bokeh-light';
        bokeh.style.left = Math.random() * 100 + 'vw';
        bokeh.style.width = (Math.random() * 150 + 50) + 'px';
        bokeh.style.height = bokeh.style.width;
        bokeh.style.animationDelay = Math.random() * 20 + 's';
        bokeh.style.background = ['var(--gold)', 'var(--love-pink)', 'var(--sad-blue)'][Math.floor(Math.random()*3)];
        container.appendChild(bokeh);
      }
    }
    function setupCustomCursor() {
      const cursor = document.getElementById('customCursor');
      document.addEventListener('mousemove', (e) => {
        cursor.style.left = e.clientX - 10 + 'px';
        cursor.style.top = e.clientY - 10 + 'px';
      });
      document.addEventListener('mousedown', () => cursor.classList.add('clicked'));
      document.addEventListener('mouseup', () => cursor.classList.remove('clicked'));
    }
    function startButterflyCursor() {
      const butterfly = document.getElementById('butterflyCursor');
      document.addEventListener('mousemove', followButterfly);
      butterfly.style.display = 'block';
    }
    function stopButterflyCursor() {
      const butterfly = document.getElementById('butterflyCursor');
      document.removeEventListener('mousemove', followButterfly);
      butterfly.style.display = 'none';
    }
    function followButterfly(e) {
      const butterfly = document.getElementById('butterflyCursor');
      butterfly.style.transform = `translate(${e.clientX + 15}px, ${e.clientY + 15}px) rotate(${e.clientX / 10}deg)`;
    }
    function createConstellation() {
      const container = document.getElementById('starsContainer');
      const centerX = window.innerWidth / 2;
      const centerY = window.innerHeight / 2;
      const positions = generateNameConstellation(herName, centerX, centerY - 150);
      positions.forEach((pos, index) => {
        setTimeout(() => {
          const star = document.createElement('div');
          star.className = 'star constellation';
          star.style.left = pos.x + 'px';
          star.style.top = pos.y + 'px';
          container.appendChild(star);
          setTimeout(() => { if (container.contains(star)) container.removeChild(star); }, 10000);
        }, index * 300);
      });
    }
    function generateNameConstellation(name, centerX, centerY) {
        const positions = [];
        const letterSpacing = 60;
        const startX = centerX - (name.length * letterSpacing) / 2;
        for (let i = 0; i < name.length; i++) {
          positions.push({ x: startX + (i * letterSpacing) + (Math.random() * 20 - 10), y: centerY + (Math.random() * 40 - 20) });
        }
        return positions;
    }
    function createCelebrationEffect() {
      const container = document.getElementById('particlesContainer');
      for (let i = 0; i < 30; i++) {
        setTimeout(() => {
          const element = document.createElement('div');
          if (Math.random() < 0.7) {
            element.className = 'heart-particle';
            element.innerHTML = ['üíñ', 'üíï', 'üíó', '‚ù§Ô∏è', 'üíú'][Math.floor(Math.random() * 5)];
          } else {
            element.className = 'sparkle';
            element.style.background = ['var(--gold)', 'var(--love-pink)'][Math.floor(Math.random() * 2)];
          }
          element.style.left = (10 + Math.random() * 80) + '%';
          element.style.animationDuration = (3 + Math.random() * 3) + 's';
          container.appendChild(element);
          setTimeout(() => { if (container.contains(element)) container.removeChild(element); }, 8000);
        }, i * 80);
      }
    }

    async function onConfigChange(config) {
      currentConfig = { ...config };
      if (config.background_color) document.documentElement.style.setProperty('--primary-bg', config.background_color);
      if (config.accent_color) document.documentElement.style.setProperty('--love-pink', config.accent_color);
      if (config.font_family) document.body.style.fontFamily = `${config.font_family}, 'Times New Roman', serif`;
      if (config.font_size) document.documentElement.style.setProperty('--base-font-size', config.font_size + 'px');
      if (!isPlaying && currentScene === 0) {
        document.getElementById('messageText').textContent = config.story_title || defaultConfig.story_title;
      }
    }
    const capabilities = {
      recolorables: [
        { get: () => currentConfig.background_color || defaultConfig.background_color, set: (value) => { currentConfig.background_color = value; onConfigChange(currentConfig); } },
        { get: () => currentConfig.accent_color || defaultConfig.accent_color, set: (value) => { currentConfig.accent_color = value; onConfigChange(currentConfig); } }
      ],
      fontEditable: { get: () => currentConfig.font_family || defaultConfig.font_family, set: (value) => { currentConfig.font_family = value; onConfigChange(currentConfig); } },
      fontSizeable: { get: () => currentConfig.font_size || defaultConfig.font_size, set: (value) => { currentConfig.font_size = value; onConfigChange(currentConfig); } }
    };
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: () => capabilities,
        mapToEditPanelValues: (config) => new Map([
          ["love_interest_name", config.love_interest_name || defaultConfig.love_interest_name],
          ["your_name", config.your_name || defaultConfig.your_name],
          ["story_title", config.story_title || defaultConfig.story_title],
          ["opening_message", config.opening_message || defaultConfig.opening_message],
          ["apology_message", config.apology_message || defaultConfig.apology_message],
          ["love_declaration", config.love_declaration || defaultConfig.love_declaration],
          ["future_message", config.future_message || defaultConfig.future_message],
          ["final_message", config.final_message || defaultConfig.final_message],
          ["enable_memories", config.enable_memories || defaultConfig.enable_memories]
        ])
      });
    }

    // Populate tone selector and wire change handler
    document.addEventListener('DOMContentLoaded', () => {
      const sel = document.getElementById('toneSelect');
      if(sel && Array.isArray(tonePresets)){
        sel.innerHTML = tonePresets.map(t=>`<option value="${t.key}">${t.key}</option>`).join('');
        sel.value = '‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶æ';
        applyToneByKey(sel.value);
        sel.addEventListener('change', () => applyToneByKey(sel.value));
      }
      const rc = document.getElementById('replayContainer');
      if (rc) rc.style.display = 'none';
    });

    document.addEventListener('DOMContentLoaded', init);
    
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('nameInputOverlay').addEventListener('keypress', (e) => { if (e.key === 'Enter') startStory(); });
      document.getElementById('memoryText').addEventListener('keypress', (e) => { if (e.key === 'Enter' && e.ctrlKey) saveMemory(); });
    });

  </script>
<script>
// ===== Custom Soft Rain Animation (retained) =====
(function(){
  const canvas = document.getElementById('softRainCanvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  let w=0,h=0, dpr=1;
  function resize(){
    dpr = window.devicePixelRatio||1;
    w = canvas.clientWidth = window.innerWidth;
    h = canvas.clientHeight = window.innerHeight;
    canvas.width = Math.floor(w*dpr);
    canvas.height= Math.floor(h*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize', resize);
  resize();

  const drops = [];
  const DROP_COUNT = 160;
  function resetDrop(d){
    d.x = Math.random()*w;
    d.y = -Math.random()*h;
    d.len = 8 + Math.random()*18;
    d.speed = 2.2 + Math.random()*3.2;
    d.thick = 0.6 + Math.random()*0.9;
    d.alpha = 0.08 + Math.random()*0.12;
  }
  for(let i=0;i<DROP_COUNT;i++){ drops.push({}); resetDrop(drops[i]); }

  function frame(){
    ctx.clearRect(0,0,w,h);
    ctx.save();
    ctx.strokeStyle = 'rgba(255,255,255,0.85)';
    ctx.filter = 'blur(0.6px)';
    ctx.lineCap = 'round';
    for(const d of drops){
      ctx.globalAlpha = d.alpha;
      ctx.lineWidth = d.thick;
      ctx.beginPath();
      ctx.moveTo(d.x, d.y);
      ctx.lineTo(d.x-2, d.y + d.len);
      ctx.stroke();
      d.y += d.speed*3.2;
      d.x -= 0.6;
      if(d.y > h+40) resetDrop(d);
    }
    ctx.restore();
    requestAnimationFrame(frame);
  }
  frame();
})();
</script>

<script>
(function(){
  const labels = ['EN','BN','HI','Audio','Skip','full','dropdown','‡¶è‡¶Ü‡¶á ‡¶â‡¶ï‡ßç‡¶§‡¶ø','‡¶è‡¶Ü‡¶á ‡¶≠‡¶Ø‡¶º‡ßá‡¶∏'];
  function hideByText(){
    const all = Array.from(document.querySelectorAll('button, a, [role="button"], .btn, .control, .lang-btn, .top-right-controls *'));
    for(const el of all){
      const t = (el.innerText||'').trim();
      if(labels.includes(t)){
        el.style.display='none';
        if(el.parentElement && el.parentElement.childElementCount<=1){
          el.parentElement.style.display='none';
        }
      }
    }
  }
  const selectors = ['#languageControls', '.language-controls', '#audioToggle', '.audio-toggle', '#skipButton', '.skip-btn', '#fullscreenBtn', '.fullscreen-btn', '.top-right-controls'];
  for(const s of selectors){
    const el = document.querySelector(s);
    if(el) el.style.display='none';
  }
  document.addEventListener('DOMContentLoaded', hideByText);
  setTimeout(hideByText, 1200);
})();
</script>

</body>
</html>



